<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wizard of Destiny Tales - Interactive Tarot</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2d1b4e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .magic-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(2px 2px at 20% 30%, white, transparent),
                        radial-gradient(2px 2px at 60% 70%, white, transparent),
                        radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200% 200%;
            animation: sparkle 8s ease-in-out infinite;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes sparkle {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .loading-animation {
            display: inline-block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 2s linear infinite;
            margin-left: 5px;
        }

        .loading-float {
            display: inline-block;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes dotPulse {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots span {
            animation: dotPulse 1.4s infinite;
            opacity: 0;
            font-size: 1.5em;
            font-weight: bold;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 20px 20px 15px 20px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #9b59b6, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: #c9b3d4;
            font-size: 18px;
            font-style: italic;
        }

        /* Step Progress */
        .progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0 20px 0;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(155, 89, 182, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border: 2px solid rgba(155, 89, 182, 0.3);
        }

        .progress-step.active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-color: #9b59b6;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.6);
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Topic Selection */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .topic-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            border-color: #9b59b6;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.4);
        }

        .topic-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .topic-title {
            font-size: 22px;
            color: #9b59b6;
            margin-bottom: 8px;
        }

        /* Question Input */
        .question-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 40px 30px;
            margin: 30px 0;
        }

        .question-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 18px;
            font-family: 'Sarabun', sans-serif;
            margin-bottom: 20px;
        }

        .question-input:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .question-input option {
            background: #2d1b4e;
            color: #fff;
            padding: 10px;
        }

        .question-input option:hover {
            background: #9b59b6;
        }

        .suggestions {
            display: grid;
            gap: 10px;
        }

        .suggestion-btn {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.4);
            color: #c9b3d4;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .suggestion-btn:hover {
            background: rgba(155, 89, 182, 0.4);
            color: #fff;
        }

        /* Package Selection */
        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .package-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .package-card:hover {
            transform: translateY(-5px);
            border-color: #9b59b6;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.4);
        }

        .package-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .package-title {
            font-size: 20px;
            color: #9b59b6;
            margin-bottom: 10px;
        }

        .package-price {
            font-size: 32px;
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .package-features {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 15px;
        }

        /* Chat Interface */
        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 12px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message-user {
            background: rgba(155, 89, 182, 0.3);
            padding: 12px 16px;
            border-radius: 15px 15px 5px 15px;
            margin-left: 20%;
            text-align: right;
        }

        .message-wizard {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 20px;
            border-radius: 15px 15px 15px 5px;
            margin-right: 5%;
            font-size: 17px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .wizard-avatar {
            display: inline-block;
            margin-right: 10px;
            font-size: 24px;
        }

        .reading-text {
            display: inline-block;
            width: 90%;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .follow-up-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .follow-up-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Sarabun', sans-serif;
        }

        .follow-up-count {
            text-align: center;
            color: #9b59b6;
            margin: 15px 0;
            font-size: 16px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px 35px;
            font-size: 18px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.4);
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(155, 89, 182, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #9b59b6;
        }

        .btn-container {
            text-align: center;
            margin: 30px 0;
        }

        /* Card Drawing */
        .card-deck {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .tarot-card {
            width: 100px;
            height: 160px;
            background: linear-gradient(135deg, #2d1b4e, #1a1f3a);
            border: 3px solid #9b59b6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tarot-card:hover {
            transform: translateY(-15px) scale(1.05);
        }

        .tarot-card.selected {
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            .topics-grid { grid-template-columns: 1fr; }
            .packages-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="magic-bg"></div>

    <div class="container">
        <header>
            <div class="logo">üîÆ</div>
            <h1>The Wizard of Destiny Tales</h1>
            <p class="tagline">‡∏ó‡∏µ‡πà‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</p>
        </header>

        <div class="progress">
            <div class="progress-step active" id="step1">1</div>
            <div class="progress-step" id="step2">2</div>
            <div class="progress-step" id="step3">3</div>
            <div class="progress-step" id="step4">4</div>
            <div class="progress-step" id="step5">5</div>
            <div class="progress-step" id="step6">6</div>
        </div>

        <!-- Screen 1: Topic Selection -->
        <div class="screen active" id="topicScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°</h2>
            <div class="topics-grid">
                <div class="topic-card" onclick="selectTopic('love', 'üíñ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå')">
                    <div class="topic-icon">üíñ</div>
                    <div class="topic-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</p>
                </div>
                <div class="topic-card" onclick="selectTopic('career', 'üíº ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏ä‡∏µ‡∏û')">
                    <div class="topic-icon">üíº</div>
                    <div class="topic-title">‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</p>
                </div>
                <div class="topic-card" onclick="selectTopic('money', 'üí∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á')">
                    <div class="topic-icon">üí∞</div>
                    <div class="topic-title">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢</p>
                </div>
                <div class="topic-card" onclick="selectTopic('health', 'üè• ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà')">
                    <div class="topic-icon">üè•</div>
                    <div class="topic-title">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•</p>
                </div>
                <div class="topic-card" onclick="selectTopic('family', 'üë®‚Äçüë©‚Äçüëß ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô')">
                    <div class="topic-icon">üë®‚Äçüë©‚Äçüëß</div>
                    <div class="topic-title">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î</p>
                </div>
                <div class="topic-card" onclick="selectTopic('spiritual', 'üåü ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì')">
                    <div class="topic-icon">üåü</div>
                    <div class="topic-title">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì</div>
                    <p style="color: #ccc; font-size: 14px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</p>
                </div>
            </div>
        </div>

        <!-- Screen 2: Question Input -->
        <div class="screen" id="questionScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <div class="question-section">
                <p style="color: #c9b3d4; margin-bottom: 15px; text-align: center;">
                    <span id="selectedTopicDisplay"></span>
                </p>
                <p style="color: #f39c12; background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; padding: 12px 15px; border-radius: 8px; font-size: 14px; margin-bottom: 20px; line-height: 1.6;">
                    ‚ú® <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÑ‡∏û‡πà‡∏Å‡πá‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô üîÆ
                </p>
                <textarea class="question-input" id="questionInput" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." oninput="updateCharCount()"></textarea>
                <p style="color: #888; font-size: 13px; margin: 5px 0 15px 0; text-align: right;">
                    <span id="charCount">0</span>/500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 10)
                </p>
                <p style="color: #aaa; font-size: 14px; margin-bottom: 15px;">üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</p>
                <div class="suggestions" id="suggestions"></div>

                <!-- Personalization Section -->
                <div style="margin-top: 30px; padding-top: 25px; border-top: 1px solid rgba(155, 89, 182, 0.3);">
                    <p style="color: #9b59b6; font-size: 16px; margin-bottom: 20px; text-align: center;">
                        ‚ú® ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="color: #c9b3d4; font-size: 14px; display: block; margin-bottom: 8px;">üë§ ‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <select id="ageRange" class="question-input" style="padding: 10px; margin: 0;">
                                <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                                <option value="18-25">18-25 ‡∏õ‡∏µ</option>
                                <option value="26-35">26-35 ‡∏õ‡∏µ</option>
                                <option value="36-45">36-45 ‡∏õ‡∏µ</option>
                                <option value="46-55">46-55 ‡∏õ‡∏µ</option>
                                <option value="56+">56+ ‡∏õ‡∏µ</option>
                            </select>
                        </div>

                        <div>
                            <label style="color: #c9b3d4; font-size: 14px; display: block; margin-bottom: 8px;">‚ößÔ∏è ‡πÄ‡∏û‡∏®</label>
                            <select id="gender" class="question-input" style="padding: 10px; margin: 0;">
                                <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                                <option value="male">‡∏ä‡∏≤‡∏¢</option>
                                <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
                                <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="color: #c9b3d4; font-size: 14px; display: block; margin-bottom: 8px;">üí≠ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</label>
                        <select id="emotionalState" class="question-input" style="padding: 10px; margin: 0;">
                            <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                            <option value="hopeful">‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏±‡∏á ‚ú®</option>
                            <option value="worried">‡∏Å‡∏±‡∏á‡∏ß‡∏• üòü</option>
                            <option value="confused">‡∏™‡∏±‡∏ö‡∏™‡∏ô ü§î</option>
                            <option value="happy">‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç üòä</option>
                            <option value="sad">‡πÄ‡∏®‡∏£‡πâ‡∏≤ üò¢</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="btn-container">
                <button class="btn btn-secondary" onclick="goBack('topicScreen')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn" onclick="goToPackages()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Screen 3: Package Selection -->
        <div class="screen" id="packageScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

            <!-- Pricing Tier Banner -->
            <div id="pricingBanner" style="background: linear-gradient(135deg, #e74c3c, #f39c12); padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center; box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);">
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;" id="tierLabel">üî• Loading...</div>
                <div style="font-size: 18px; margin-bottom: 15px;" id="tierMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©...</div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 10px; display: inline-block;">
                    <div style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á</div>
                    <div style="font-size: 36px; font-weight: 700;" id="spotsRemaining">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ!</div>
                </div>
                <div style="margin-top: 15px; font-size: 14px; opacity: 0.9;" id="nextTierInfo">‚ö° ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ</div>
            </div>

            <div class="packages-grid">
                <div class="package-card" onclick="selectPackageWithPrice('quick', 1, 1, 'basic')">
                    <div class="package-icon">‚ú®</div>
                    <div class="package-title">‡πÑ‡∏û‡πà‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤</div>
                    <div style="text-decoration: line-through; color: #999; font-size: 14px; margin-bottom: 5px;">‡∏ø199</div>
                    <div class="package-price" id="price-basic">‡∏ø-</div>
                    <div style="color: #2ecc71; font-weight: 600; font-size: 14px; margin-bottom: 10px;" id="discount-basic">-% OFF</div>
                    <div class="package-features">
                        ‚Ä¢ ‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö<br>
                        ‚Ä¢ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° 1 ‡∏Ç‡πâ‡∏≠<br>
                        ‚Ä¢ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    </div>
                </div>
                <div class="package-card" onclick="selectPackageWithPrice('deep', 3, 2, 'premium')">
                    <div class="package-icon">üåü</div>
                    <div class="package-title">‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á</div>
                    <div style="text-decoration: line-through; color: #999; font-size: 14px; margin-bottom: 5px;">‡∏ø399</div>
                    <div class="package-price" id="price-premium">‡∏ø-</div>
                    <div style="color: #2ecc71; font-weight: 600; font-size: 14px; margin-bottom: 10px;" id="discount-premium">-% OFF</div>
                    <div class="package-features">
                        ‚Ä¢ ‡πÑ‡∏û‡πà 3 ‡πÉ‡∏ö (‡∏≠‡∏î‡∏µ‡∏ï-‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)<br>
                        ‚Ä¢ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° 2 ‡∏Ç‡πâ‡∏≠<br>
                        ‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
                    </div>
                </div>
                <div class="package-card" style="border: 2px solid #f39c12;" onclick="selectPackageWithPrice('complete', 10, 3, 'ultimate')">
                    <div style="position: absolute; top: -15px; right: 10px; background: linear-gradient(135deg, #f39c12, #e67e22); padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚≠ê POPULAR</div>
                    <div class="package-icon">‚ö°</div>
                    <div class="package-title">‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
                    <div style="text-decoration: line-through; color: #999; font-size: 14px; margin-bottom: 5px;">‡∏ø799</div>
                    <div class="package-price" id="price-ultimate">‡∏ø-</div>
                    <div style="color: #2ecc71; font-weight: 600; font-size: 14px; margin-bottom: 10px;" id="discount-ultimate">-% OFF</div>
                    <div class="package-features">
                        ‚Ä¢ ‡πÑ‡∏û‡πà 10 ‡πÉ‡∏ö (Celtic Cross)<br>
                        ‚Ä¢ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° 3 ‡∏Ç‡πâ‡∏≠<br>
                        ‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö
                    </div>
                </div>
            </div>
            <div class="btn-container">
                <button class="btn btn-secondary" onclick="goBack('questionScreen')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>

        <!-- Screen 4: Payment -->
        <div class="screen" id="paymentScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>

            <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(155, 89, 182, 0.3); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; color: #f39c12; margin-bottom: 5px;">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</div>
                    <div id="selectedPackageName" style="font-size: 24px; font-weight: 600; color: #fff; margin-bottom: 10px;">-</div>
                    <div style="font-size: 36px; font-weight: 700; color: #f39c12;" id="paymentAmount">‡∏ø0</div>
                </div>

                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="text-align: center; color: #9b59b6; margin-bottom: 15px; font-size: 18px;">üì± ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>

                    <!-- QR Code Payment -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="color: #ccc; margin-bottom: 10px; font-size: 16px; font-weight: 600;">‡∏™‡πÅ‡∏Å‡∏ô QR Code (PromptPay)</div>
                        <div style="background: white; padding: 15px; border-radius: 10px; display: inline-block; margin-bottom: 10px;">
                            <img src="/promptpay-qr.jpg" alt="PromptPay QR Code" style="width: 200px; height: 200px; display: block;">
                        </div>
                        <div style="color: #999; font-size: 14px;">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                    </div>

                    <div style="height: 1px; background: rgba(155, 89, 182, 0.3); margin: 20px 0;"></div>

                    <!-- Manual Transfer -->
                    <div style="margin-bottom: 15px;">
                        <div style="color: #ccc; margin-bottom: 15px; font-size: 16px; font-weight: 600; text-align: center;">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">
                                <span style="color: #999;">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
                                <span style="color: #fff; font-weight: 600;">Kasikorn Bank (‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢)</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <span style="color: #999;">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                <span style="color: #fff; font-weight: 600;">Mr. Thomas Som Janisch</span>
                            </div>
                            <div>
                                <span style="color: #999;">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                <span style="color: #f39c12; font-weight: 600; font-size: 18px;">847-2-10962-7</span>
                                <button onclick="copyAccountNumber()" style="margin-left: 10px; padding: 5px 10px; background: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; color: #f39c12; border-radius: 5px; cursor: pointer; font-size: 12px;">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div style="background: rgba(243, 156, 18, 0.1); border: 2px dashed #f39c12; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 18px; color: #f39c12; margin-bottom: 15px; font-weight: 600;">üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div style="color: #ccc; margin-bottom: 15px; font-size: 14px;">
                        ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£<br>
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    </div>

                    <input type="file" id="paymentProof" accept="image/*" style="display: none;" onchange="handlePaymentProofUpload(event)">
                    <button onclick="document.getElementById('paymentProof').click()" class="btn" style="background: linear-gradient(135deg, #f39c12, #e67e22); margin-bottom: 10px;">
                        üì§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
                    </button>

                    <div id="uploadPreview" style="margin-top: 15px; display: none;">
                        <img id="previewImage" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin-bottom: 10px;">
                        <div id="uploadStatus" style="color: #f39c12; font-size: 14px;"></div>
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" onclick="goBack('packageScreen')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn" id="verifyPaymentBtn" onclick="verifyPayment()" disabled style="opacity: 0.5;">
                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                </button>
            </div>
        </div>

        <!-- Screen 5: Card Drawing -->
        <div class="screen" id="cardScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <p style="text-align: center; color: #c9b3d4; margin-bottom: 20px;">
                ‡∏à‡∏±‡∏ö‡∏™‡∏±‡πà‡∏ô‡πÑ‡∏û‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì...
            </p>
            <div class="btn-container">
                <button class="btn btn-secondary" onclick="shuffleCards()">üîÄ ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà</button>
            </div>
            <div class="card-deck" id="cardDeck"></div>
            <p style="text-align: center; color: #ddd; margin: 20px 0;">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="selectedCount">0</span> / <span id="totalNeeded">1</span>
            </p>
            <div class="btn-container">
                <button class="btn" id="revealBtn" onclick="revealReading()" disabled>‚ú® ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</button>
            </div>
        </div>

        <!-- Screen 6: Reading & Chat -->
        <div class="screen" id="chatScreen">
            <h2 style="text-align: center; margin-bottom: 20px; color: #9b59b6;">‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <div class="chat-container" id="chatMessages"></div>

            <p style="color: #f39c12; background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; padding: 12px 15px; border-radius: 8px; font-size: 14px; margin: 20px 0; line-height: 1.6;">
                üí¨ <strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
                ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏û‡πà‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏à‡∏∞‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏û‡πà‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
            </p>

            <div class="follow-up-count" id="followUpCount">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 1</div>
            <div class="follow-up-input">
                <input type="text" id="followUpInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°...">
                <button class="btn" onclick="askFollowUp()">‡∏™‡πà‡∏á</button>
            </div>
            <div class="btn-container" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="startOver()">üîÑ ‡∏î‡∏π‡∏î‡∏ß‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                <button class="btn" onclick="downloadReading()">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</button>
                <button class="btn" onclick="shareReading()" style="background: linear-gradient(135deg, #e74c3c, #f39c12);">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</button>
                <button class="btn" onclick="showReviewModal()" style="background: linear-gradient(135deg, #f39c12, #e67e22);">‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div style="background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 10px 50px rgba(155, 89, 182, 0.3); border: 1px solid rgba(155, 89, 182, 0.3);">
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 24px; background: linear-gradient(135deg, #9b59b6, #e74c3c, #f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                ‚≠ê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            </h2>

            <p style="text-align: center; color: #ccc; margin-bottom: 20px; font-size: 14px;">
                ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö üôè
            </p>

            <!-- Star Rating -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?</div>
                <div id="starRating" style="font-size: 40px; cursor: pointer;">
                    <span class="star" data-rating="1">‚òÜ</span>
                    <span class="star" data-rating="2">‚òÜ</span>
                    <span class="star" data-rating="3">‚òÜ</span>
                    <span class="star" data-rating="4">‚òÜ</span>
                    <span class="star" data-rating="5">‚òÜ</span>
                </div>
                <div id="ratingText" style="color: #f39c12; margin-top: 10px; font-size: 14px; min-height: 20px;"></div>
            </div>

            <!-- Feedback Text -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 14px;">
                    ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                </label>
                <textarea id="reviewFeedback" placeholder="‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." style="width: 100%; min-height: 100px; padding: 12px; border-radius: 10px; border: 1px solid rgba(155, 89, 182, 0.3); background: rgba(255, 255, 255, 0.05); color: #fff; font-family: 'Sarabun', sans-serif; font-size: 14px; resize: vertical;" maxlength="1000"></textarea>
                <div style="text-align: right; color: #999; font-size: 12px; margin-top: 5px;">
                    <span id="feedbackCount">0</span>/1000
                </div>
            </div>

            <!-- Quick Questions -->
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(155, 89, 182, 0.2);">
                <div style="margin-bottom: 12px;">
                    <label style="color: #ccc; font-size: 14px; cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" id="wasHelpful" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì
                    </label>
                </div>
                <div>
                    <label style="color: #ccc; font-size: 14px; cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" id="wouldRecommend" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                    </label>
                </div>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 10px;">
                <button onclick="closeReviewModal()" style="flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(155, 89, 182, 0.5); background: transparent; color: #fff; cursor: pointer; font-size: 16px; font-family: 'Sarabun', sans-serif;">
                    ‡∏õ‡∏¥‡∏î
                </button>
                <button onclick="submitReview()" style="flex: 1; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; cursor: pointer; font-size: 16px; font-family: 'Sarabun', sans-serif; font-weight: 600;">
                    ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
                </button>
            </div>

            <!-- Submission Status -->
            <div id="reviewStatus" style="margin-top: 15px; padding: 12px; border-radius: 10px; display: none; text-align: center; font-size: 14px;"></div>
        </div>
    </div>

    <script>
        // Session persistence functions
        function saveSession() {
            const sessionData = {
                currentScreen,
                selectedTopic,
                selectedTopicName,
                userQuestion,
                selectedPackage,
                followUpCount,
                selectedCards,
                conversationHistory,
                userProfile,
                paymentVerified: window.paymentVerified || false,
                timestamp: Date.now()
            };
            console.log('üíæ Saving session:', { currentScreen, paymentVerified: window.paymentVerified });
            localStorage.setItem('tarotSession', JSON.stringify(sessionData));
        }

        function loadSession() {
            try {
                const saved = localStorage.getItem('tarotSession');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Only restore if less than 24 hours old
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        return data;
                    } else {
                        localStorage.removeItem('tarotSession');
                    }
                }
            } catch (e) {
                console.error('Error loading session:', e);
            }
            return null;
        }

        function clearSession() {
            localStorage.removeItem('tarotSession');
        }

        // Initialize state
        let currentScreen = 'topicScreen';
        let selectedTopic = '';
        let selectedTopicName = '';
        let userQuestion = '';
        let selectedPackage = {};
        let followUpCount = 0;
        let selectedCards = [];
        let conversationHistory = [];
        let userProfile = {
            ageRange: '',
            gender: '',
            emotionalState: ''
        };
        let reviewIncentiveShown = false;
        let hasEarnedBonus = false;
        let totalFollowUpsUsed = 0;

        // Restore session on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Check for fresh start parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fresh') === 'true') {
                console.log('üÜï Fresh start requested - clearing session');
                localStorage.removeItem('tarotSession');
                window.location.href = window.location.pathname; // Remove URL params
                return;
            }

            const savedSession = loadSession();
            console.log('üìÇ Loading session:', savedSession ? { currentScreen: savedSession.currentScreen, paymentVerified: savedSession.paymentVerified } : 'No session');
            // ONLY restore session if payment was verified (customer protection - they paid!)
            if (savedSession && savedSession.paymentVerified && savedSession.currentScreen !== 'topicScreen') {
                // AUTO-RESTORE SESSION (no confirmation needed - customer protection!)
                // Restore all state
                currentScreen = savedSession.currentScreen;
                selectedTopic = savedSession.selectedTopic;
                selectedTopicName = savedSession.selectedTopicName;
                userQuestion = savedSession.userQuestion;
                selectedPackage = savedSession.selectedPackage;
                followUpCount = savedSession.followUpCount;
                selectedCards = savedSession.selectedCards;
                conversationHistory = savedSession.conversationHistory;
                userProfile = savedSession.userProfile;

                // IMPORTANT: Restore payment verification status
                if (savedSession.paymentVerified) {
                    window.paymentVerified = true;
                }

                console.log('‚úÖ Restored to screen:', currentScreen, 'Payment verified:', window.paymentVerified);

                // Wait for DOM to be ready, then restore UI
                setTimeout(() => {
                    // Restore payment screen UI elements if package was selected
                    if (selectedPackage && selectedPackage.type) {
                        document.getElementById('selectedPackageName').textContent = selectedPackage.type;
                        document.getElementById('paymentAmount').textContent = `‡∏ø${selectedPackage.price}`;
                    }

                    // Restore UI
                    goToScreen(currentScreen);

                    // Update progress indicator based on screen
                    const progressMap = {
                        'topicScreen': 1,
                        'questionScreen': 2,
                        'packageScreen': 3,
                        'paymentScreen': 4,
                        'cardScreen': 5,
                        'chatScreen': 6
                    };
                    updateProgress(progressMap[currentScreen] || 1);

                    // Restore card screen if needed
                    if (currentScreen === 'cardScreen' && selectedPackage.cards) {
                        initializeCards(selectedPackage.cards);
                    }

                    if (currentScreen === 'chatScreen') {
                        // Rebuild chat history
                        const chatDiv = document.getElementById('chatMessages');
                        chatDiv.innerHTML = ''; // Clear first
                        conversationHistory.forEach(msg => {
                            if (msg.role === 'wizard') {
                                addWizardMessage(msg.text);
                            } else {
                                addUserMessage(msg.text);
                            }
                        });
                        document.getElementById('followUpCount').textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${followUpCount}`;

                        // Show restoration notice with option to start fresh
                        const notice = document.createElement('div');
                        notice.style.cssText = `
                            position: fixed;
                            top: 80px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: linear-gradient(135deg, #9b59b6, #8e44ad);
                            color: white;
                            padding: 20px 25px;
                            border-radius: 15px;
                            box-shadow: 0 4px 20px rgba(155, 89, 182, 0.6);
                            font-size: 15px;
                            z-index: 10000;
                            max-width: 90%;
                            text-align: center;
                            animation: slideDown 0.5s;
                        `;
                        notice.innerHTML = `
                            <div style="margin-bottom: 12px;">
                                üíæ <strong>‡πÄ‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</strong>
                            </div>
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                                ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                            </div>
                            <button onclick="this.parentElement.remove()" style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.4);
                                color: white;
                                padding: 8px 15px;
                                border-radius: 8px;
                                font-size: 13px;
                                cursor: pointer;
                                font-family: 'Sarabun', sans-serif;
                                margin-right: 8px;
                            ">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                            <button onclick="localStorage.removeItem('tarotSession'); window.location.reload();" style="
                                background: #e74c3c;
                                border: none;
                                color: white;
                                padding: 8px 15px;
                                border-radius: 8px;
                                font-size: 13px;
                                cursor: pointer;
                                font-family: 'Sarabun', sans-serif;
                                font-weight: 600;
                            ">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                        `;
                        document.body.appendChild(notice);

                        // Add slideDown animation
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes slideDown {
                                from {
                                    opacity: 0;
                                    transform: translateX(-50%) translateY(-20px);
                                }
                                to {
                                    opacity: 1;
                                    transform: translateX(-50%) translateY(0);
                                }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }, 100);
            }
        });

        const suggestions = {
            love: [
                '‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà',
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£',
                '‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏â‡∏±‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏â‡∏±‡∏ô‡∏Ñ‡∏ß‡∏£‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏õ'
            ],
            career: [
                '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏°',
                '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏´‡∏≤‡∏â‡∏±‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÑ‡∏´‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô'
            ],
            money: [
                '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏°',
                '‡∏Ñ‡∏ß‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°',
                '‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏≤‡∏â‡∏±‡∏ô‡πÑ‡∏´‡∏°'
            ],
            health: [
                '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£',
                '‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô',
                '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£',
                '‡∏à‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡πá‡∏ß‡πÑ‡∏´‡∏°'
            ],
            family: [
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏à‡∏∞‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£',
                '‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏â‡∏±‡∏ô‡πÑ‡∏´‡∏°',
                '‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô‡πÑ‡∏´‡∏°'
            ],
            spiritual: [
                '‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£',
                '‡∏â‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°',
                '‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏∞‡∏ô‡∏≥‡∏û‡∏≤‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç',
                '‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£'
            ]
        };

        function updateCharCount() {
            const input = document.getElementById('questionInput');
            const count = document.getElementById('charCount');
            const length = input.value.length;
            count.textContent = length;

            // Color coding
            if (length < 10) {
                count.style.color = '#e74c3c'; // Red
            } else if (length > 500) {
                count.style.color = '#e74c3c'; // Red
            } else {
                count.style.color = '#2ecc71'; // Green
            }
        }

        function selectTopic(topic, name) {
            selectedTopic = topic;
            selectedTopicName = name;
            document.getElementById('selectedTopicDisplay').textContent = name;
            // Don't save session yet - only save after payment

            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            suggestions[topic].forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = s;
                btn.onclick = () => {
                    document.getElementById('questionInput').value = s;
                };
                suggestionsDiv.appendChild(btn);
            });

            goToScreen('questionScreen');
            updateProgress(2);
        }

        function goToPackages() {
            userQuestion = document.getElementById('questionInput').value.trim();

            // Validate question
            if (!userQuestion) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                return;
            }

            if (userQuestion.length < 10) {
                alert('‚ùå ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡πà‡∏≠‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô\n\n(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + userQuestion.length + ' ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
                return;
            }

            if (userQuestion.length > 500) {
                alert('‚ùå ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£\n\n(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + userQuestion.length + ' ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)');
                return;
            }

            // Capture personalization data
            userProfile.ageRange = document.getElementById('ageRange').value;
            userProfile.gender = document.getElementById('gender').value;
            userProfile.emotionalState = document.getElementById('emotionalState').value;
            // Don't save session yet - only save after payment

            goToScreen('packageScreen');
            updateProgress(3);
            loadPricing(); // Load current pricing tier
        }

        // Load current pricing tier
        let currentPricingTier = null;

        async function loadPricing() {
            try {
                const response = await fetch('/api/get-pricing');
                const data = await response.json();

                if (data.success) {
                    currentPricingTier = data.currentTier;

                    // Update banner
                    document.getElementById('tierLabel').textContent = currentPricingTier.label;
                    document.getElementById('spotsRemaining').textContent = currentPricingTier.spotsRemaining;

                    // Update tier message
                    if (currentPricingTier.discount > 0) {
                        document.getElementById('tierMessage').textContent =
                            `‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á ${currentPricingTier.discount}% ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°!`;
                    } else {
                        document.getElementById('tierMessage').textContent =
                            `‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á`;
                    }

                    // Update next tier info
                    if (data.nextTier) {
                        document.getElementById('nextTierInfo').textContent =
                            `‚ö° ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏ø${data.nextTier.prices.basic} / ‡∏ø${data.nextTier.prices.premium} / ‡∏ø${data.nextTier.prices.ultimate}`;
                    } else {
                        document.getElementById('nextTierInfo').textContent =
                            `üëë ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`;
                    }

                    // Update package prices
                    document.getElementById('price-basic').textContent = `‡∏ø${currentPricingTier.prices.basic}`;
                    document.getElementById('price-premium').textContent = `‡∏ø${currentPricingTier.prices.premium}`;
                    document.getElementById('price-ultimate').textContent = `‡∏ø${currentPricingTier.prices.ultimate}`;

                    // Update discount badges
                    if (currentPricingTier.discount > 0) {
                        document.getElementById('discount-basic').textContent = `${currentPricingTier.discount}% OFF`;
                        document.getElementById('discount-premium').textContent = `${currentPricingTier.discount}% OFF`;
                        document.getElementById('discount-ultimate').textContent = `${currentPricingTier.discount}% OFF`;
                    } else {
                        document.getElementById('discount-basic').style.display = 'none';
                        document.getElementById('discount-premium').style.display = 'none';
                        document.getElementById('discount-ultimate').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading pricing:', error);
                // Fallback to default prices
                document.getElementById('tierLabel').textContent = 'üí´ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©';
                document.getElementById('price-basic').textContent = '‡∏ø199';
                document.getElementById('price-premium').textContent = '‡∏ø399';
                document.getElementById('price-ultimate').textContent = '‡∏ø799';
            }
        }

        function selectPackageWithPrice(type, cards, followUps, packageTier) {
            if (!currentPricingTier) {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                return;
            }

            const price = currentPricingTier.prices[packageTier];
            selectedPackage = { type, price, cards, followUps, packageTier };
            followUpCount = followUps;
            // Don't save session yet - only save after payment

            // Check for test mode (skip payment)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test') === 'skip') {
                // TEST MODE: Skip payment and go directly to card selection
                console.log('TEST MODE: Skipping payment');
                proceedToCardSelection();
                return;
            }

            // Show payment screen
            document.getElementById('selectedPackageName').textContent = type;
            document.getElementById('paymentAmount').textContent = `‡∏ø${price}`;

            goToScreen('paymentScreen');
            updateProgress(4);
        }

        function selectPackage(type, price, cards, followUps) {
            selectedPackage = { type, price, cards, followUps };
            followUpCount = followUps;
            // Don't save session yet - only save after payment

            // Check for test mode (skip payment)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test') === 'skip') {
                // TEST MODE: Skip payment and go directly to card selection
                console.log('TEST MODE: Skipping payment');
                proceedToCardSelection();
                return;
            }

            // Show payment screen
            document.getElementById('selectedPackageName').textContent = type;
            document.getElementById('paymentAmount').textContent = `‡∏ø${price}`;

            goToScreen('paymentScreen');
            updateProgress(4);
        }

        function proceedToCardSelection() {
            // Called after payment verification
            window.paymentVerified = true;
            goToScreen('cardScreen');
            updateProgress(5);
            initializeCards(selectedPackage.cards);
            saveSession(); // Save AFTER screen change so currentScreen is correct
        }

        function initializeCards(count) {
            const deck = document.getElementById('cardDeck');
            deck.innerHTML = '';
            document.getElementById('totalNeeded').textContent = count;
            selectedCards = [];

            for (let i = 0; i < 10; i++) {
                const card = document.createElement('div');
                card.className = 'tarot-card';
                card.innerHTML = 'üÇ†';
                card.onclick = () => selectCard(i, count);
                deck.appendChild(card);
            }
        }

        function shuffleCards() {
            const cards = document.querySelectorAll('.tarot-card');
            cards.forEach(card => {
                card.style.transform = 'rotateY(180deg)';
                setTimeout(() => card.style.transform = '', 600);
            });
        }

        function selectCard(index, needed) {
            if (selectedCards.length >= needed) return;

            const cards = document.querySelectorAll('.tarot-card');
            const card = cards[index];
            if (card.classList.contains('selected')) return;

            card.classList.add('selected');
            selectedCards.push(index);

            document.getElementById('selectedCount').textContent = selectedCards.length;

            if (selectedCards.length === needed) {
                document.getElementById('revealBtn').disabled = false;
            }
        }

        async function revealReading() {
            goToScreen('chatScreen');
            updateProgress(5);

            conversationHistory = [];

            // Show loading message with animation (don't save to history)
            addWizardMessage(`
                <span class="loading-float">üîÆ</span>
                <span class="loading-animation">üßô‚Äç‚ôÇÔ∏è ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                <br>
                <em style="color: #c9b3d4;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</em>
                <span class="loading-spinner">‚ú®</span>
                <span class="loading-animation">üí´</span>
                <span class="loading-spinner">üåü</span>
            `, false);

            // Call API for initial reading with retry mechanism
            let retryCount = 0;
            const maxRetries = 3;
            let reading = null;

            while (retryCount < maxRetries && !reading) {
                try {
                    reading = await generateReading(selectedTopic, userQuestion, selectedPackage.type, false);

                    // Success! Remove loading message
                    const chatDiv = document.getElementById('chatMessages');
                    chatDiv.innerHTML = '';

                    // Add actual reading
                    addWizardMessage(reading);
                    saveSession(); // Save after successful reading
                } catch (error) {
                    retryCount++;
                    console.error(`Error generating reading (attempt ${retryCount}/${maxRetries}):`, error);

                    if (retryCount < maxRetries) {
                        // Update loading message to show retry (don't save to history)
                        const chatDiv = document.getElementById('chatMessages');
                        chatDiv.innerHTML = '';
                        addWizardMessage(`
                            <span class="loading-float">üîÆ</span>
                            <span class="loading-animation">üßô‚Äç‚ôÇÔ∏è ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                            <br>
                            <em style="color: #c9b3d4;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß... (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${retryCount + 1})</em>
                            <span class="loading-spinner">‚ú®</span>
                            <span class="loading-animation">üí´</span>
                            <span class="loading-spinner">üåü</span>
                        `, false);
                        // Wait 2 seconds before retrying
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } else {
                        // All retries failed - show error with retry button
                        const chatDiv = document.getElementById('chatMessages');
                        chatDiv.innerHTML = '';
                        addWizardMessage(`
                            üòî ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß
                            <br><br>
                            <strong style="color: #f39c12;">üí° ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏•!</strong>
                            <br>
                            ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                            <br><br>
                            <button onclick="retryReading()" style="
                                background: linear-gradient(135deg, #9b59b6, #8e44ad);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 25px;
                                font-size: 18px;
                                cursor: pointer;
                                font-family: 'Sarabun', sans-serif;
                                box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
                            ">üîÑ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                        `);
                    }
                }
            }

            document.getElementById('followUpCount').textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${followUpCount}`;
        }

        async function retryReading() {
            // Clear chat and retry
            const chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML = '';

            // Show loading message (don't save to history)
            addWizardMessage(`
                <span class="loading-float">üîÆ</span>
                <span class="loading-animation">üßô‚Äç‚ôÇÔ∏è ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                <br>
                <em style="color: #c9b3d4;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</em>
                <span class="loading-spinner">‚ú®</span>
                <span class="loading-animation">üí´</span>
                <span class="loading-spinner">üåü</span>
            `, false);

            // Try again
            try {
                const reading = await generateReading(selectedTopic, userQuestion, selectedPackage.type, false);
                chatDiv.innerHTML = '';
                addWizardMessage(reading);
                saveSession(); // Save after successful retry
            } catch (error) {
                console.error('Retry failed:', error);
                chatDiv.innerHTML = '';
                addWizardMessage(`
                    üòî ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                    <br><br>
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á Line ‡∏´‡∏£‡∏∑‡∏≠ Facebook
                    <br>
                    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                    <br><br>
                    <button onclick="retryReading()" style="
                        background: linear-gradient(135deg, #9b59b6, #8e44ad);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 18px;
                        cursor: pointer;
                        font-family: 'Sarabun', sans-serif;
                    ">üîÑ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                `);
            }
        }

        async function generateReading(topic, question, packageType, isFollowUp = false) {
            try {
                const response = await fetch('/api/tarot-reading', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        topic: selectedTopic,
                        topicName: selectedTopicName,
                        question: question,
                        packageType: packageType,
                        cardCount: selectedPackage.cards,
                        userProfile: userProfile,
                        isFollowUp: isFollowUp,
                        conversationHistory: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return data.reading;
            } catch (error) {
                console.error('Error calling API:', error);
                throw error;
            }
        }

        function addWizardMessage(text, saveToHistory = true) {
            const chatDiv = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message';

            // Format the text with proper line breaks
            const formattedText = text
                .replace(/\n\n/g, '<br><br>')  // Double line breaks
                .replace(/\n/g, '<br>');         // Single line breaks

            msg.innerHTML = `
                <div class="message-wizard">
                    <span class="wizard-avatar">üßô‚Äç‚ôÇÔ∏è</span>
                    <div class="reading-text">${formattedText}</div>
                </div>
            `;
            chatDiv.appendChild(msg);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            // Only save to history if not a temporary message (like loading indicators)
            if (saveToHistory) {
                conversationHistory.push({ role: 'wizard', text });
            }
        }

        function addUserMessage(text) {
            const chatDiv = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            msg.innerHTML = `<div class="message-user">${text}</div>`;
            chatDiv.appendChild(msg);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            conversationHistory.push({ role: 'user', text });
        }

        async function askFollowUp() {
            if (followUpCount <= 0) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß üòä\n\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞!');
                return;
            }

            const input = document.getElementById('followUpInput');
            const question = input.value.trim();

            if (!question) return;

            addUserMessage(question);
            input.value = '';

            followUpCount--;
            document.getElementById('followUpCount').textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${followUpCount}`;

            // Show loading (don't save to history)
            addWizardMessage('üßô‚Äç‚ôÇÔ∏è ‡∏û‡πà‡∏≠‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡∏á‡∏•‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÑ‡∏û‡πà<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>', false);

            try {
                const response = await generateReading(selectedTopic, question, selectedPackage.type, true);

                // Remove loading message
                const messages = document.querySelectorAll('.chat-message');
                messages[messages.length - 1].remove();

                // Add real response
                addWizardMessage(response);
                totalFollowUpsUsed++;
                saveSession(); // Save after follow-up answer

                // Show review incentive after FIRST follow-up answer (wait 20 seconds)
                // Show even if followUpCount = 0 (for Basic package with only 1 follow-up)
                if (!reviewIncentiveShown && totalFollowUpsUsed === 1) {
                    reviewIncentiveShown = true;
                    setTimeout(() => {
                        // Only show if they haven't earned bonus yet
                        if (!hasEarnedBonus) {
                            showReviewIncentive();
                        }
                    }, 20000); // 20 seconds delay
                }

                if (followUpCount === 0) {
                    setTimeout(() => {
                        // If they haven't reviewed yet AND incentive popup won't appear, show final request
                        // Don't show if totalFollowUpsUsed === 1 (incentive popup will show instead)
                        if (!hasEarnedBonus && totalFollowUpsUsed !== 1) {
                            addWizardMessage(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üåü\n\nüí¨ ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? ‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô üôè`);
                            setTimeout(() => {
                                showFinalReviewRequest();
                            }, 1000);
                        } else if (hasEarnedBonus || totalFollowUpsUsed === 1) {
                            addWizardMessage(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üåü ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡πÉ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì! üí´‚ú®`);
                        }
                        document.getElementById('followUpInput').disabled = true;
                        saveSession(); // Save when all follow-ups used
                    }, 1500);
                }
            } catch (error) {
                console.error('Error generating follow-up:', error);
                const messages = document.querySelectorAll('.chat-message');
                messages[messages.length - 1].remove();
                addWizardMessage('üòî ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                followUpCount++; // Restore the count since it failed
                document.getElementById('followUpCount').textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${followUpCount}`;
            }
        }

        function downloadReading() {
            // Get the reading content
            const chatMessages = document.getElementById('chatMessages');
            const readingContent = chatMessages.innerHTML;

            // Create a new window for printing
            const printWindow = window.open('', '', 'width=800,height=600');

            // Write formatted HTML
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>The Wizard of Destiny Tales - Your Reading</title>
                    <style>
                        body {
                            font-family: 'Sarabun', Arial, sans-serif;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            color: #333;
                            font-size: 18px;
                        }
                        h1 {
                            color: #9b59b6;
                            text-align: center;
                            margin-bottom: 3px;
                            margin-top: 0;
                            font-size: 28px;
                        }
                        .subtitle {
                            text-align: center;
                            color: #666;
                            margin-bottom: 12px;
                            font-style: italic;
                            font-size: 14px;
                        }
                        .reading-content {
                            line-height: 1.8;
                            white-space: pre-wrap;
                            font-size: 17px;
                        }
                        .message-wizard {
                            background: #f8f5fc;
                            padding: 18px;
                            border-radius: 10px;
                            margin: 10px 0;
                            border-left: 4px solid #9b59b6;
                        }
                        .wizard-avatar {
                            font-size: 24px;
                            margin-right: 8px;
                        }
                        .reading-text {
                            line-height: 1.8;
                            font-size: 17px;
                        }
                        .footer {
                            margin-top: 25px;
                            padding-top: 15px;
                            border-top: 2px solid #9b59b6;
                            text-align: center;
                            color: #999;
                            font-size: 12px;
                        }
                        @media print {
                            body {
                                padding: 15px;
                                font-size: 15px;
                            }
                            h1 {
                                font-size: 24px;
                                margin-bottom: 2px;
                            }
                            .subtitle {
                                margin-bottom: 10px;
                                font-size: 13px;
                            }
                            .message-wizard {
                                padding: 15px;
                                margin: 8px 0;
                            }
                            .reading-content,
                            .reading-text {
                                font-size: 15px;
                                line-height: 1.7;
                            }
                            .footer {
                                margin-top: 20px;
                                padding-top: 12px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <h1>üîÆ The Wizard of Destiny Tales</h1>
                    <div class="subtitle">‡∏ó‡∏µ‡πà‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</div>
                    <div class="reading-content">
                        ${readingContent}
                    </div>
                    <div class="footer">
                        <p>‚ú® Generated by The Wizard of Destiny Tales ‚ú®</p>
                        <p>wizard-interactive-v2.vercel.app</p>
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();

            // Wait for content to load, then trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Review incentive system
        function showReviewIncentive() {
            const popup = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%); border: 2px solid #f39c12; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 50px rgba(243, 156, 18, 0.6); z-index: 10000;" id="reviewIncentivePopup">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üéÅ</div>
                        <h2 style="color: #f39c12; margin: 0 0 15px 0;">‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì!</h2>
                        <p style="color: #fff; font-size: 18px; margin-bottom: 10px;">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÅ‡∏Ñ‡πà 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
                        <div style="background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                            <div style="color: #2ecc71; font-weight: 700; font-size: 24px; margin-bottom: 5px;">üéÅ ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700;">‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å +1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!</div>
                            <div style="color: #ccc; font-size: 14px; margin-top: 8px;">(‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ${selectedPackage.followUps > 0 ? Math.round(selectedPackage.price / selectedPackage.followUps) : '50-100'} ‡∏ö‡∏≤‡∏ó)</div>
                        </div>
                        <button onclick="openQuickReview()" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 18px 40px; border-radius: 30px; font-size: 20px; font-weight: 700; cursor: pointer; font-family: 'Sarabun', sans-serif; margin-bottom: 15px; width: 100%; box-shadow: 0 5px 20px rgba(243, 156, 18, 0.4);">‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏•‡∏¢ ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!</button>
                        <button onclick="closeReviewIncentive()" style="background: transparent; color: #999; border: 1px solid #666; padding: 12px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; font-family: 'Sarabun', sans-serif; width: 100%;">‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô</button>
                    </div>
                </div>
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999;" id="reviewIncentiveOverlay" onclick="closeReviewIncentive()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', popup);
        }

        function closeReviewIncentive() {
            const popup = document.getElementById('reviewIncentivePopup');
            const overlay = document.getElementById('reviewIncentiveOverlay');
            if (popup) popup.remove();
            if (overlay) overlay.remove();
        }

        function openQuickReview() {
            closeReviewIncentive();
            showQuickReviewForm();
        }

        let selectedRating = 0;
        const reviewTemplates = ['‚ú® ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å! ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á', 'üéØ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô', 'üíé ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡∏Å', '‚ö° ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô'];

        function showQuickReviewForm() {
            const form = `<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%); border: 2px solid #9b59b6; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(155, 89, 182, 0.6); z-index: 10000;" id="quickReviewForm"><h2 style="color: #9b59b6; margin: 0 0 20px 0; text-align: center;">‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πà‡∏ß‡∏ô</h2><div style="margin-bottom: 20px;"><label style="color: #fff; display: block; margin-bottom: 10px; font-size: 16px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label><div id="starRating" style="text-align: center; margin-bottom: 15px;"><span onclick="setRating(1)" style="font-size: 40px; cursor: pointer; color: #666;">‚≠ê</span><span onclick="setRating(2)" style="font-size: 40px; cursor: pointer; color: #666;">‚≠ê</span><span onclick="setRating(3)" style="font-size: 40px; cursor: pointer; color: #666;">‚≠ê</span><span onclick="setRating(4)" style="font-size: 40px; cursor: pointer; color: #666;">‚≠ê</span><span onclick="setRating(5)" style="font-size: 40px; cursor: pointer; color: #666;">‚≠ê</span></div></div><div style="margin-bottom: 20px;"><label style="color: #fff; display: block; margin-bottom: 10px; font-size: 16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏á:</label><div style="display: grid; gap: 10px; margin-bottom: 15px;"><button onclick="selectTemplate(0)" class="tpl-btn" style="background: rgba(155, 89, 182, 0.2); border: 2px solid rgba(155, 89, 182, 0.3); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; text-align: left;">‚ú® ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å!</button><button onclick="selectTemplate(1)" class="tpl-btn" style="background: rgba(155, 89, 182, 0.2); border: 2px solid rgba(155, 89, 182, 0.3); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; text-align: left;">üéØ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</button><button onclick="selectTemplate(2)" class="tpl-btn" style="background: rgba(155, 89, 182, 0.2); border: 2px solid rgba(155, 89, 182, 0.3); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; text-align: left;">üíé ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å</button><button onclick="selectTemplate(3)" class="tpl-btn" style="background: rgba(155, 89, 182, 0.2); border: 2px solid rgba(155, 89, 182, 0.3); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; text-align: left;">‚ö° ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</button></div><textarea id="quickReviewText" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏≠‡∏á..." style="width: 100%; min-height: 80px; padding: 15px; border-radius: 10px; border: 1px solid rgba(155, 89, 182, 0.3); background: rgba(255, 255, 255, 0.05); color: #fff; font-family: 'Sarabun', sans-serif; font-size: 16px;"></textarea></div><button onclick="submitQuickReview()" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 18px; border-radius: 30px; font-size: 18px; font-weight: 700; cursor: pointer; font-family: 'Sarabun', sans-serif; width: 100%; margin-bottom: 10px;">‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß ‚Üí ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å +1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button><button onclick="closeQuickReview()" style="background: transparent; color: #999; border: 1px solid #666; padding: 12px; border-radius: 25px; font-size: 16px; cursor: pointer; font-family: 'Sarabun', sans-serif; width: 100%;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div><div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999;" id="quickReviewOverlay"></div>`;
            document.body.insertAdjacentHTML('beforeend', form);
        }

        function setRating(stars) {
            selectedRating = stars;
            const starElements = document.querySelectorAll('#starRating span');
            starElements.forEach((star, index) => { star.style.color = index < stars ? '#f39c12' : '#666'; });
        }

        function selectTemplate(index) {
            document.getElementById('quickReviewText').value = reviewTemplates[index];
            document.querySelectorAll('.tpl-btn').forEach((btn, i) => {
                btn.style.background = i === index ? 'rgba(155, 89, 182, 0.5)' : 'rgba(155, 89, 182, 0.2)';
                btn.style.borderColor = i === index ? '#9b59b6' : 'rgba(155, 89, 182, 0.3)';
            });
        }

        async function submitQuickReview() {
            if (selectedRating === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚≠ê'); return; }
            const feedback = document.getElementById('quickReviewText').value.trim();
            if (!feedback) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß'); return; }

            try {
                const response = await fetch('/api/submit-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rating: selectedRating,
                        package: selectedPackage.type,
                        topic: selectedTopicName,
                        feedback: feedback,
                        helpful: true,
                        wouldRecommend: selectedRating >= 4
                    })
                });

                if (response.ok) {
                    closeQuickReview();
                    followUpCount++;
                    hasEarnedBonus = true;
                    document.getElementById('followUpCount').textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${followUpCount}`;
                    saveSession();
                    addWizardMessage(`üéÅ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° +1 ‡πÅ‡∏•‡πâ‡∏ß! üåü\n\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${followUpCount} ‡∏Ç‡πâ‡∏≠`);
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }

        function closeQuickReview() {
            const form = document.getElementById('quickReviewForm');
            const overlay = document.getElementById('quickReviewOverlay');
            if (form) form.remove();
            if (overlay) overlay.remove();
        }

        function showFinalReviewRequest() {
            const reminder = `<div style="background: rgba(243, 156, 18, 0.1); border: 2px dashed #f39c12; border-radius: 15px; padding: 20px; text-align: center; margin-top: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">üí¨</div><p style="color: #fff; margin: 0 0 15px 0;">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°? üôè</p><button onclick="openQuickReview()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; font-family: 'Sarabun', sans-serif;">‚≠ê ‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</button></div>`;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', reminder);
        }

        function shareReading() {
            // Get the reading text (clean version without HTML)
            const chatMessages = document.getElementById('chatMessages');
            const readingElements = chatMessages.querySelectorAll('.reading-text');

            let readingText = '';
            readingElements.forEach(el => {
                readingText += el.innerText + '\n\n';
            });

            // Create formatted share text
            const shareText = `üîÆ‚ú® The Wizard of Destiny Tales ‚ú®üîÆ\n\n${readingText}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí´ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á?\nüåü ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏µ‡πà: wizard-interactive-v2.vercel.app`;

            // Check if Web Share API is available (mobile devices)
            if (navigator.share) {
                navigator.share({
                    title: 'üîÆ The Wizard of Destiny Tales',
                    text: shareText,
                    url: 'https://wizard-interactive-v2.vercel.app'
                }).then(() => {
                    console.log('Shared successfully');
                }).catch((error) => {
                    console.log('Share failed:', error);
                    fallbackShare(shareText);
                });
            } else {
                // Fallback for desktop - show share options dialog
                fallbackShare(shareText);
            }
        }

        function fallbackShare(shareText) {
            // Create modal for share options
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%);
                    padding: 30px;
                    border-radius: 20px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 0 40px rgba(155, 89, 182, 0.5);
                ">
                    <h2 style="color: #9b59b6; margin: 0 0 20px 0; text-align: center;">üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h2>

                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                        <p style="color: #fff; font-size: 14px; margin: 0; white-space: pre-wrap; line-height: 1.6;">${shareText}</p>
                    </div>

                    <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                        <button onclick="copyToClipboard()" style="
                            background: linear-gradient(135deg, #3498db, #2980b9);
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 16px;
                            cursor: pointer;
                            font-family: 'Sarabun', sans-serif;
                        ">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>

                        <a href="https://social-plugins.line.me/lineit/share?url=https://wizard-interactive-v2.vercel.app" target="_blank" style="
                            background: linear-gradient(135deg, #00c300, #00b300);
                            color: white;
                            text-decoration: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 16px;
                            text-align: center;
                            font-family: 'Sarabun', sans-serif;
                        ">üíö ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE</a>

                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://wizard-interactive-v2.vercel.app" target="_blank" style="
                            background: linear-gradient(135deg, #3b5998, #2d4373);
                            color: white;
                            text-decoration: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 16px;
                            text-align: center;
                            font-family: 'Sarabun', sans-serif;
                        ">üìò ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô Facebook</a>

                        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent('üîÆ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å The Wizard of Destiny Tales ‚ú®')}&url=https://wizard-interactive-v2.vercel.app" target="_blank" style="
                            background: linear-gradient(135deg, #1da1f2, #0d8bd9);
                            color: white;
                            text-decoration: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 16px;
                            text-align: center;
                            font-family: 'Sarabun', sans-serif;
                        ">üê¶ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô Twitter</a>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border: 2px solid rgba(255,255,255,0.3);
                        padding: 12px;
                        border-radius: 10px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 100%;
                        font-family: 'Sarabun', sans-serif;
                    ">‡∏õ‡∏¥‡∏î</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Copy to clipboard function
            window.copyToClipboard = function() {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡πÉ‡∏ô Line, Facebook ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏≠‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
                }).catch(() => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = shareText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                });
            };
        }

        // ============ REVIEW SYSTEM ============
        // Note: selectedRating is already declared in global variables section

        function showReviewModal() {
            document.getElementById('reviewModal').style.display = 'flex';

            // Set up star rating interactivity
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                });
                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    updateStars(hoverRating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', function() {
                updateStars();
            });

            // Character counter
            document.getElementById('reviewFeedback').addEventListener('input', function() {
                document.getElementById('feedbackCount').textContent = this.value.length;
            });
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            // Reset form
            selectedRating = 0;
            updateStars();
            document.getElementById('reviewFeedback').value = '';
            document.getElementById('feedbackCount').textContent = '0';
            document.getElementById('wasHelpful').checked = false;
            document.getElementById('wouldRecommend').checked = false;
            document.getElementById('reviewStatus').style.display = 'none';
        }

        function updateStars(hoverRating = null) {
            const rating = hoverRating || selectedRating;
            const stars = document.querySelectorAll('.star');
            const ratingTexts = ['', '‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à', '‡∏û‡∏≠‡πÉ‡∏ä‡πâ', '‡∏î‡∏µ', '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!'];

            stars.forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '‚òÖ';
                    star.style.color = '#f39c12';
                } else {
                    star.textContent = '‚òÜ';
                    star.style.color = '#666';
                }
            });

            document.getElementById('ratingText').textContent = rating > 0 ? ratingTexts[rating] : '';
        }

        async function submitReview() {
            // Validation
            if (selectedRating === 0) {
                showReviewStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
                return;
            }

            const feedback = document.getElementById('reviewFeedback').value.trim();
            const wasHelpful = document.getElementById('wasHelpful').checked;
            const wouldRecommend = document.getElementById('wouldRecommend').checked;

            // Show loading
            showReviewStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...', 'loading');

            try {
                const response = await fetch('/api/submit-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        feedback: feedback,
                        package: selectedPackage || 'Unknown',
                        topic: selectedTopicName || 'Unknown',
                        helpful: wasHelpful,
                        wouldRecommend: wouldRecommend
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showReviewStatus('‚úÖ ' + data.message, 'success');

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeReviewModal();
                    }, 2000);
                } else {
                    showReviewStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'), 'error');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                showReviewStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        }

        function showReviewStatus(message, type) {
            const statusEl = document.getElementById('reviewStatus');
            statusEl.textContent = message;
            statusEl.style.display = 'block';

            if (type === 'success') {
                statusEl.style.background = 'rgba(46, 204, 113, 0.2)';
                statusEl.style.border = '1px solid #2ecc71';
                statusEl.style.color = '#2ecc71';
            } else if (type === 'error') {
                statusEl.style.background = 'rgba(231, 76, 60, 0.2)';
                statusEl.style.border = '1px solid #e74c3c';
                statusEl.style.color = '#e74c3c';
            } else {
                statusEl.style.background = 'rgba(243, 156, 18, 0.2)';
                statusEl.style.border = '1px solid #f39c12';
                statusEl.style.color = '#f39c12';
            }
        }
        // ============ END REVIEW SYSTEM ============

        // ============ PAYMENT SYSTEM ============
        let uploadedProofImage = null;

        function copyAccountNumber() {
            const accountNumber = '847-2-10962-7';
            navigator.clipboard.writeText(accountNumber).then(() => {
                alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n' + accountNumber);
            }).catch(() => {
                alert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + accountNumber);
            });
        }

        function handlePaymentProofUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedProofImage = e.target.result;

                // Show preview
                document.getElementById('previewImage').src = uploadedProofImage;
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('uploadStatus').textContent = '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';

                // Enable verify button
                document.getElementById('verifyPaymentBtn').disabled = false;
                document.getElementById('verifyPaymentBtn').style.opacity = '1';
            };
            reader.readAsDataURL(file);
        }

        async function verifyPayment() {
            if (!uploadedProofImage) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const verifyBtn = document.getElementById('verifyPaymentBtn');
            const statusEl = document.getElementById('uploadStatus');

            // Show loading
            verifyBtn.disabled = true;
            verifyBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            statusEl.textContent = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AI...';
            statusEl.style.color = '#f39c12';

            try {
                const response = await fetch('/api/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: uploadedProofImage,
                        expectedAmount: selectedPackage.price,
                        packageType: selectedPackage.type
                    })
                });

                const data = await response.json();

                if (data.success && data.verified) {
                    // Payment verified!
                    statusEl.textContent = '‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà...';
                    statusEl.style.color = '#2ecc71';

                    setTimeout(() => {
                        proceedToCardSelection();
                    }, 2000);
                } else {
                    // Verification failed
                    statusEl.textContent = '‚ùå ' + (data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    statusEl.style.color = '#e74c3c';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                statusEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                statusEl.style.color = '#e74c3c';
                verifyBtn.disabled = false;
                verifyBtn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            }
        }
        // ============ END PAYMENT SYSTEM ============

        function startOver() {
            goToScreen('topicScreen');
            updateProgress(1);
            selectedCards = [];
            conversationHistory = [];
            document.getElementById('questionInput').value = '';
            document.getElementById('followUpInput').disabled = false;
        }

        function goToScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            window.scrollTo(0, 0);
        }

        function goBack(screenId) {
            goToScreen(screenId);
            const stepMap = {
                'topicScreen': 1,
                'questionScreen': 2,
                'packageScreen': 3,
                'paymentScreen': 4,
                'cardScreen': 5,
                'chatScreen': 6
            };
            updateProgress(stepMap[screenId]);
        }

        function updateProgress(step) {
            for (let i = 1; i <= 6; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i <= step) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
            }
        }
    </script>
</body>
</html>